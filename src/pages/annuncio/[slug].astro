---
import { Breadcrumb, Separator, User, Result, Badge } from '@/components/index';
import { IconWhatsapp, IconPhone, IconHeart } from '@/icons/index';
import MainLayout from '@/layouts/main-layout.astro';
import { fetchData } from '@/lib/api';
import Gallery from '@/shared/listings/gallery.astro';
import SimilarListings from '@/shared/sections/similar-listings.astro';
import { getBreadcrumbSchema } from '@/utils/schema/page';
import Map from '@/components/map.astro';
import Tags from '@/shared/tags.astro';
import ShareButton from '@/components/share-button.astro';

const { params } = Astro;
const currentPath = Astro.url.pathname;
const slug = params.slug;

// API Request
const { data, isLoading, isError, errorCode } = await fetchData(`/listings/${slug}`);

const { data: listing, similarListings: similar_listings } = data || {};

// Set HTTP status code based on error condition
if (isError) {
	Astro.response.status = errorCode && typeof errorCode === 'number' ? errorCode : 404;
}

// Safely access data properties only if data exists
const similarListings = data?.similar_listings || [];

// Create breadcrumbs only if data exists
const breadcrumbs =
	listing ?
		[
			{ name: 'Home', url: '/' },
			{ name: listing?.province?.name || 'Province', url: `/${listing?.province?.slug || ''}` },
			{ name: listing?.category?.name || 'Category', url: `/${listing?.province?.slug || ''}/${listing?.category?.slug || ''}` },
			{ name: listing?.title || 'Listing', url: listing?.slug || '' },
		]
	:	[];

// schema.org
const schemaORG = getBreadcrumbSchema([
	{ url: 'https://it.onlyescort.vip/', name: 'OnlyEscort' },
	{ url: `https://it.onlyescort.vip${currentPath}`, name: listing?.title || 'Annuncio' },
]);
---

<MainLayout
	title={listing?.title ?? 'Annuncio'}
	schema={schemaORG}>
	<div class="container px-4 py-6">
		{
			isLoading && (
				<div class="flex justify-center items-center py-12">
					<p class="text-center text-gray-400">Caricamento in corso...</p>
				</div>
			)
		}

		{
			!isLoading && isError && (
				<Result
					code={errorCode}
					title={errorCode === 404 ? 'Annuncio non trovato' : "Errore nel caricamento dell'annuncio"}
					description={
						errorCode === 404 ?
							"L'annuncio che stai cercando potrebbe essere stato rimosso."
						:	"Si è verificato un problema durante il caricamento dell'annuncio. Riprova più tardi."
					}
				/>
			)
		}

		{
			data && (
				<>
				<div class="mb-6 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 sm:gap-4">
					<Breadcrumb links={breadcrumbs} />
					<div class="flex items-center gap-2 self-start sm:self-end">
						<button class="btn btn-outline btn-outline-ghost sm:text-base">
							<IconHeart/>
							Salva
						</button>
						<ShareButton 
							title="Guarda questo annuncio incredibile!" 
							text="Ho trovato questo annuncio e penso possa interessarti." 
							url={currentPath}
						/>
					</div>
				</div>
									<Separator />
					<div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
						<div>
							<div class="flex flex-wrap gap-2 mb-2">
								{listing?.category?.name && <Badge>{listing?.category?.name}</Badge>}
								{listing?.province?.name && <Badge>{listing?.province?.name}</Badge>}
							</div>
							<h1 class="text-2xl md:text-3xl font-bold">{listing?.title}</h1>
						</div>
					</div>

					<section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
						<div class="lg:col-span-2 space-y-6">
							{/* Gallery Section */}
							<section
								id="listing-gallery"
								class="mb-6">
								{listing?.images && (
									<Gallery
										images={listing?.images}
										alt={listing?.title}
										meta={listing}
									/>
								)}
							</section>

							<Separator />

							{/* Description Section */}
							<section
								id="listing-description"
								class="mb-6">
								<p class="leading-relaxed text-muted-foreground break-words">{listing?.description}</p>
							</section>

							<Separator />

							{/* Details Section */}
							{listing?.tags?.length > 0 && (
								<section
									id="listing-details"
									class="mb-6">
									<span class="text-xl block font-semibold mb-4">Dettagli</span>
									{listing?.tags && <Tags data={listing?.tags} />}
								</section>
							)}

							{/* Map Section */}
							{listing?.lon && listing?.lat && (
								<section
									id="listing-map"
									class="py-6">
									<span class="text-xl block font-semibold mb-4">Location</span>
									<Map
										lon={listing?.lon}
										lat={listing?.lat}
									/>
								</section>
							)}
						</div>

						{/* Right Side (Sticky Card) */}
						<div class="lg:sticky top-6 self-start flex flex-col space-y-4">
							<div class="card">
							<div class="card-body">
								<div slot="title">
									<span class="text-lg font-bold">Informazioni sul profilo</span>
								</div>
								<div
									slot="content"
									class="rounded-2xl flex flex-col space-y-4">
									{listing?.profile && (
										<User
											size="md"
											withRating={true}
											data={listing?.profile}
										/>
									)}
									<Separator />
									<a class="btn btn-primary"
										href={`tel:${listing?.phone_number || ''}`}>
										<IconPhone />
										{listing?.phone_number || 'Chiama ora'}
									</button>
									<a class="btn btn-whatsapp w-full"
										href={`https://api.whatsapp.com/send/?phone_number=${listing?.whatsapp_number || ''}&text=Ciao ho visto il tuo annuncio su ${encodeURIComponent(currentPath)}&type=phone_number&app_absent=0`}>
										<IconWhatsapp />
										Whatsapp
									</a>
								</div>
							</div>
						</div>
					</section>

					{/* Similar Listings */}
					{similarListings && similarListings.length > 0 && (
						<SimilarListings
							data={similarListings}
						/>
					)}
				</>
			)
		}
	</div>
</MainLayout>
